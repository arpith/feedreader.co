(function(){
  var feed = ''
  , article = ''
  , bookmarklet = feedreader.bookmarklet || null
  , api = function(method,endpoint,callback,params) {
    var xhr = new XMLHttpRequest()
    , urlparams = '?token='+this.token
    if (params) if (method==='GET') urlparams = "?"+params
    xhr.open(method,'https://feedreader.co/'+this.user+'/'+endpoint+'/json'+urlparams)
    xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded")
    xhr.onload = callback
    xhr.send(params)
  }
  , makePillbox = function(e) {
    e.style.background = '#D1D0CE'
    e.style.border = 'thin solid #D1D0CE'
    e.style.color = 'white'
    e.style.fontSize = '0.8em'
    e.style.padding = '0.2em'
    e.style.paddingLeft = '0.4em'
    e.style.paddingRight = '0.4em'
    e.style.marginRight = '0.1em'
    e.style.borderRadius = '0.2em'
    e.className = "feedreader-pillbox"
  }
  , makeEmpty = function(e) {
    e.style.background = 'white'
    e.style.color = '#4A525A'
    e.style.borderColor = '#D1D0CE'
    e.className = "feedreader-pillbox-empty"
  }
  , toggleBookmarklet = function(callback) {
    if (!bookmarklet) {
      var newFolder = document.createElement('input')
      , addFolder = document.createElement('input')
      , elements = [newFolder, addFolder]
      newFolder.placeholder = "New Folder"
      addFolder.value = "Add"
      addFolder.type = 'submit'
      addFolder.onclick = function() {
        addToFolder(displayFolder(value))
        newFolder.value = ''
        return false
      }
      elements.forEach(function(e){
        makePillbox(e)
        e.style.textDecoration = 'none'
        e.style.WebkitAppearance = 'none'
        e.style.fontFamily = 'inherit!important'
      })
      makeEmpty(newFolder)
      bookmarklet = document.createElement('div')
      bookmarklet.style.font = '19px Georgia,sans'
      bookmarklet.style.color = 'black'
      bookmarklet.style.lineHeight = '30px'
      bookmarklet.style.position = 'fixed'
      bookmarklet.style.overflow = 'scroll'
      bookmarklet.style.top = '0'
      bookmarklet.style.right = '0'
      bookmarklet.style.zindex = '99999'
      bookmarklet.style.background = 'white'
      bookmarklet.style.padding = '10px'
      bookmarklet.appendChild(newFolder)
      bookmarklet.appendChild(addFolder)
      feedreader.bookmarklet = bookmarklet
      document.body.appendChild(bookmarklet)
    }
    else {
      if (bookmarklet.style.right==='0') bookmarklet.style.right = '-100%'
      else bookmarklet.style.right= '0'
    }
    if (callback) callback()
  }
  , removeFromFolder = function(folderButton) {
    var folder = folderButton.value
    api('DELETE','folders/'+folder,function(){
      if ((success = JSON.parse(this.responseText).success)) if (success === true) makeEmpty(folderButton)
    },'xmlurl='+feed)
  }
  , addToFolder = function(folderButton) {
    var folder = folderButton.value
    api('POST','folders/'+folder,function(){
      if ((success = JSON.parse(this.responseText).success)) if (success === true) makePillbox(folderButton)
    },'xmlurl='+feed)
  }
  , displayFolder = function(folder) {
    var folderButton = document.createElement('input')
    folderButton.type = 'submit'
    folderButton.value = folder
    folderButton.id = folder
    folderButton.onclick = function() {
      if (folderButton.className==="feedreader-pillbox") removeFromFolder(folderButton)
      else addToFolder(folderButton)
      return false
    }
    makePillbox(folderButton)
    makeEmpty(folderButton)
    bookmarklet.appendChild(folderButton)
    return folderButton
  }
  , getFeed = function(callback) {
    if (window.location.hostname == 'feedreader.co') feed = current.children[1].href.slice(28)
    if (!feed) {
      var linkTags = document.getElementsByTagName('link')
      , aTags = document.getElementsByTagName('a')
      for (var i = 0; i < linkTags.length; ++i) {
        var tag = linkTags[i]
        if (tag.rel === 'alternate') if ((tag.type.indexOf('atom')!=-1)||(tag.type.indexOf('rss')!=-1)||(tag.type.indexOf('xml')!=-1)) {
          feed = tag.href
          break
        }
      }
      if (!feed) for (var i = 0; i < aTags.length; ++i) {
        var tag = aTags[i]
        if ((tag.innerHTML.indexOf('atom')!=-1)||(tag.innerHTML.indexOf('rss')!=-1)||(tag.innerHTML.indexOf('xml')!=-1)) {
          feed = tag.href
          break
        }
      }
    }
    console.log(feed)
    callback()
  }
  , postFeed = function() {
    if (window.location.hostname!='feedreader.co') api('POST','feeds',function(){
      console.log(this.responseText)
    },'xmlurl='+feed+'&title='+window.location.hostname+'&link='+window.location.hostname)
  }
  this.token = feedreader.token
  this.user = feedreader.user
  feedreader = this
  feedreader.bookmarklet = bookmarklet
  getFeed(function(){
    toggleBookmarklet(function(){
      api('GET','folders',function(){
        var checked = false
        if ((folders = JSON.parse(this.responseText).allFolders)) {
          checked = true
          folders.forEach(function(folder,position){
            if (position < folders.length) displayFolder(folder)
            else postFeed()
          })
        }
        if ((folders = JSON.parse(this.responseText).folders)) folders.forEach(function(folder,position){
          if (position < folders.length) {
            if (checked) makePillbox(document.getElementById(folder))
            else displayFolder(folder)
          }
          else  if (!checked) postFeed()
        })
      },'xmlurl='+feed)
    })
  })
})()
